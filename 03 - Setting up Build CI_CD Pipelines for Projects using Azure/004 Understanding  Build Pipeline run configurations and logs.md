# **Chapter 8: Executing and Enhancing the Build Pipeline**

## **8.1 Committing the Pipeline Configuration**

The YAML file defining the build pipeline must be part of the source code repository. This allows Azure Pipelines to locate and execute it.
*   Selecting **"Save and run"** commits the auto-generated `azure-pipelines.yml` file directly to the specified branch (e.g., `main`) in your GitHub repository.
*   This action both stores the configuration and triggers the first pipeline run.

## **8.2 Executing the Pipeline**

1.  **Manual Trigger:** After saving the YAML file, you can manually start a pipeline run by selecting the branch and clicking **"Run"**.
2.  **Automated Trigger:** Any future push to the `main` branch (as defined by the `trigger:` keyword in the YAML) will automatically start a new pipeline run.

## **8.3 Pipeline Execution Logs: A Step-by-Step Breakdown**

The execution log provides visibility into each step the pipeline performs on the hosted agent.

1.  **Agent Selection:** The pipeline provisions a fresh **Ubuntu** virtual machine (the hosted agent) as specified by `vmImage: 'ubuntu-latest'`.
2.  **Repository Checkout:** The agent's first task is to clone the connected GitHub repository into its own workspace. The code is placed in a directory following the pattern `$(Pipeline.Workspace)/s/` (where `s` stands for **source**).
3.  **Maven Execution:** The agent navigates to the source directory and executes the Maven goal specified in the YAML file (`goals: 'package'`). This step:
    *   Downloads all project dependencies defined in `pom.xml`.
    *   Compiles the source code.
    *   Runs unit tests.
    *   Packages the successful build into a `.war` file (the artifact), which is created in the `target/` directory on the agent's file system.

## **8.4 The Need to Publish Artifacts**

The build was successful, but the resulting `.war` file remains trapped on the temporary Ubuntu agent. Once the pipeline job finishes, the agent is destroyed, and all files on it are lost.

To make the artifact available for deployment, it must be **published** back to Azure DevOps. This makes it a managed, downloadable entity that can be promoted to subsequent stages (e.g., deployment pipelines).

## **8.5 Enhancing the YAML to Publish the Artifact**

The initial template only builds the artifact. We must add a new task to publish it.

The required addition to the `azure-pipelines.yml` file is a **PublishBuildArtifacts** task:

```yaml
# ... existing YAML code (trigger, pool, Maven task) ...

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'package'

# NEW TASK: This publishes the .war file generated by the Maven 'package' goal
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.SourcesDirectory)/target/*.war' # Path to the artifact
    ArtifactName: 'drop' # The name of the artifact container
    publishLocation: 'Container' # Publish to Azure Pipelines
```

### **Explanation of the New Task:**
*   **`PublishBuildArtifacts@1`:** This is the task that uploads files to Azure DevOps.
*   **`PathtoPublish`:** This defines the path to the file(s) we want to publish.
    *   `$(Build.SourcesDirectory)` is a pre-defined variable that points to the directory where the source code was cloned (e.g., `/home/vsts/work/1/s`).
    *   We append `/target/*.war` to point to the `.war` file generated by Maven.
*   **`ArtifactName`:** This is the name of the artifact container that will be created in Azure DevOps. You can name it anything (e.g., 'my-web-app').
*   **`publishLocation: 'Container'`:** This specifies that the artifact should be published to the Azure Pipelines service.

After adding this task and committing the change to the repository, the next pipeline run will build the project **and** publish the resulting `.war` file as a downloadable artifact within the Azure DevOps portal, making it ready for deployment.

---
### **Key Concepts**

| Concept | Description |
| :--- | :--- |
| **Pipeline Run** | A single execution instance of a pipeline, triggered either manually or by an event. |
| **Hosted Agent** | A temporary, on-demand virtual machine provided by Azure to run pipeline jobs. It is destroyed after the job completes. |
| **Checkout** | The process where the pipeline agent clones the source code repository into its own workspace. |
| **PublishBuildArtifacts** | The Azure Pipelines task used to save build outputs (artifacts) so they persist after the agent is destroyed and can be used in later stages. |
| **Pre-defined Variables** | Variables provided by Azure Pipelines, such as `$(Build.SourcesDirectory)`, that give information about the pipeline environment. |
